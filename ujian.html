<script>

const API_URL = "https://uziefozgozmnckfssoyv.supabase.co";
const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6aWVmb3pnb3ptbmNrZnNzb3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwOTI5NTQsImV4cCI6MjA4NjY2ODk1NH0.YNfUm4BF3gKN3C0luUKN445BYcHYiD7OhAmkKTFOW-A";

let allStudents = [];


// Load murid
async function loadMurid(){

  try{

    const res = await fetch(`${API_URL}/rest/v1/students?select=id,nama,kelas`,{
      headers:{
        "apikey": API_KEY,
        "Authorization": `Bearer ${API_KEY}`
      }
    });

    if(!res.ok){
      throw new Error("Fetch gagal");
    }

    allStudents = await res.json();


    const kelasSet = new Set();

    allStudents.forEach(s=>{
      if(s.kelas) kelasSet.add(s.kelas);
    });


    const kelasSelect = document.getElementById("kelasSelect");
    kelasSelect.innerHTML = '<option value="">Semua</option>';


    kelasSet.forEach(k=>{
      const o = document.createElement("option");
      o.value = k;
      o.textContent = k;
      kelasSelect.appendChild(o);
    });


    updateMurid();

  }catch(err){

    console.error("LOAD ERROR:", err);
    alert("Gagal load data murid");

  }

}


// Update murid ikut kelas
function updateMurid(){

  const kelas = document.getElementById("kelasSelect").value;
  const muridSelect = document.getElementById("muridSelect");

  muridSelect.innerHTML = '<option value="">Pilih Murid</option>';


  allStudents.forEach(s=>{

    if(kelas === "" || s.kelas === kelas){

      const o = document.createElement("option");
      o.value = s.id;
      o.textContent = `${s.nama} (${s.kelas})`;
      muridSelect.appendChild(o);

    }

  });

}


// Simpan keputusan
async function simpan(){

  const student_id = document.getElementById("muridSelect").value;
  const sifir = document.getElementById("sifir").value;
  const status = document.getElementById("status").value;
  const teacher_id = localStorage.getItem("teacher_id");


  if(!student_id || !sifir || !status || !teacher_id){

    document.getElementById("msg").innerText="❗ Lengkapkan semua data";
    document.getElementById("msg").style.color="red";
    return;

  }


  const res = await fetch(`${API_URL}/rest/v1/scores`,{

    method:"POST",

    headers:{
      "Content-Type":"application/json",
      apikey:API_KEY,
      Authorization:`Bearer ${API_KEY}`
    },

    body:JSON.stringify({
      student_id,
      sifir,
      markah: status === "Lulus" ? 1 : 0,
      teacher_id
    })

  });


  if(res.ok){

    document.getElementById("msg").innerText="✅ Rekod disimpan!";
    document.getElementById("msg").style.color="green";

  }else{

    document.getElementById("msg").innerText="❌ Gagal simpan";
    document.getElementById("msg").style.color="red";

  }

}


// Logout
function logout(){

  localStorage.clear();
  window.location.href="login.html";

}


// Start
loadMurid();

document.getElementById("kelasSelect").addEventListener("change", updateMurid);

</script>
